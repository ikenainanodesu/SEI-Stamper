# SEI Stamper プラグイン

<img src="pic\sei_stamper_gau.png" alt="isolated" width="250"/>


**OBS Studio用フレームレベルビデオ同期**

[English](README.md) | [中文](README.chs.md) | [日本語](#日本語)

---

## 日本語

### 概要

SEI Stamperは、SEI（補足拡張情報）を使用してビデオストリームにNTPタイムスタンプを埋め込むことで、複数のストリーム間で**フレームレベルのビデオ同期**を実現するOBS Studioプラグインです。

**主な機能：**
- 🎯 **フレーム精度の同期** - NTPタイムスタンプを使用
- 📡 **複数のハードウェアエンコーダ** - Intel QuickSync、NVIDIA NVENC、AMD AMF
- 🎞️ **マルチコーデックサポート** - **H.264**、**H.265 (HEVC)**、および **AV1** に対応
- 🚀 **GPUアクセラレーション** - SEI対応のハードウェアアクセラレーションH.264エンコード
- 🔄 **送信機と受信機** - エンコードとデコードの完全なソリューション
- 🌐 **SRTストリーミング** - 低遅延ストリーミング用のSRT受信機を内蔵
- ⏱️ **マイクロ秒精度** - プロフェッショナルアプリケーション向けのNTPベースタイミング

### 使用例

- マルチカメラライブプロダクション同期
- リモートスタジオのフレームレベル同期
- 放送品質のマルチソース位置合わせ
- ライブコンサート/イベントのマルチアングル録画

### デモ動画

📺 **[YouTubeでデモ動画を見る](https://youtu.be/JhizRlUpSlg)**

このデモンストレーションでは、OBSから同じ設定で4つのSRTストリームをローカルネットワーク経由で送信しています。本プラグインを使用すると、4つのストリーム全てが±2フレーム以内の精度で同期されます。

---

## インストール

### クイックインストール（推奨）

[Releases](https://github.com/ikenainanodesu/sei-stamper/releases)ページから最新リリースをダウンロードしてください。

リリースパッケージには以下が含まれます：
- `sei-stamper.dll` - メインプラグイン
- `srt.dll` - 受信機機能用のSRTライブラリ
- 多言語サポート用のロケールファイル

### 必要条件

- OBS Studio 32.0.4以降
- Windows 10/11 (64ビット)

### 手動インストール手順

1. **[Releases](https://github.com/ikenainanodesu/sei-stamper/releases)ページからリリースパッケージをダウンロード**

2. **OBSプラグインディレクトリにコピー：**
   ```powershell
   # プラグインDLLをコピー
   Copy-Item sei-stamper.dll "C:\Program Files\obs-studio\obs-plugins\64bit\"
   
   # SRTライブラリをコピー
   Copy-Item srt.dll "C:\Program Files\obs-studio\obs-plugins\64bit\"
   ```

3. **ロケールファイルをコピー：**
   ```powershell
   # ディレクトリを作成
   New-Item -ItemType Directory -Force `
        "C:\Program Files\obs-studio\data\obs-plugins\sei-stamper\locale"
   
   # ロケールファイルをコピー
   Copy-Item data\locale\* `
        "C:\Program Files\obs-studio\data\obs-plugins\sei-stamper\locale\" -Recurse
   ```

4. **OBS Studioを再起動**

---

## 使用方法

### 送信機（エンコーダ）

1. **設定 → 出力 → 出力モード：詳細**を開く
2. 希望するコーデック形式に基づいてSEI Stamperエンコーダを選択：
   - **SEI Stamper (H.264)** - 互換性重視
   - **SEI Stamper (H.265)** - 高圧縮率 (HEVC)、帯域幅を30-50%節約（**推奨**）
   - **SEI Stamper (AV1)** - 次世代高効率コーデック (*注意: SRTストリーミング対応はOBSバージョンに依存*)
3. エンコーダ設定で**ハードウェアエンコーダ**を選択：
   - Intel QuickSync
   - NVIDIA NVENC
   - AMD AMF
4. エンコーダプロパティを設定：
   - **NTPサーバー**: `time.windows.com`（または任意のNTPサーバー）
   - **NTPポート**: `123`（デフォルト）
   - **NTP同期を有効化**: ✓
5. ストリーミング/録画を開始

> **⚠️ AV1に関する注意**: プラグインはAV1エンコードをサポートしていますが、OBS StudioのバージョンによってSRT出力でのAV1ストリーミングがサポートされていない場合があります。H.264とH.265はSRTで完全に動作確認されています。

### 受信機（ソース）

1. OBSシーンで、**ソースを追加 +**をクリック
2. **SEI Receiver**を選択
3. ソースを設定：
   - **SRT URL**: `srt://送信機IP:ポート`（例：`srt://192.168.1.100:9000`）
   - **NTP同期を有効化**: ✓
   - **NTPサーバー**: 送信機と同じ
4. **OK**をクリック

**注意**：受信機はストリームのコーデック形式（H.264/H.265/AV1）を自動的に検出します。手動選択は不要です。

---

## 検証

### FFprobeでSEIデータを確認

```powershell
# フレーム情報を表示
ffprobe -select_streams v:0 -show_frames output.mp4 2>&1 | Select-String "SEI"

# 詳細なフレームデータ
ffprobe -select_streams v:0 -show_frames -show_entries frame=pict_type output.mp4
```

### MediaInfoで確認

```powershell
MediaInfo --Full output.mp4 | Select-String "SEI"
```

---

## 技術詳細

### アーキテクチャ

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│    送信機    │         │  SRTストリーム│         │    受信機    │
│ (エンコーダ) │───────▶│   + SEI      │───────▶│  (ソース)   │
└─────────────┘         └──────────────┘         └─────────────┘
      │                                                  │
      ▼                                                  ▼
┌─────────────┐                                  ┌─────────────┐
│ NTPクライアント│◀────────────────────────────────▶│ NTPクライアント│
└─────────────┘         NTPサーバー              └─────────────┘
```

### SEI形式

- **UUID**: カスタム識別子（`a5b3c2d1-e4f5-6789-abcd-ef0123456789`）
- **ペイロードタイプ**: User Data Unregistered（タイプ5）
- **データ構造**:
  - UUID（16バイト）
  - PTS（8バイト）
  - NTPタイムスタンプ（8バイト：秒4バイト + 小数4バイト）

### NTP同期戦略

#### エンコーダ（送信機）
- **同期間隔**: 60秒ごと
- **トリガー**: エンコード中の自動定期同期
- **目的**: エンコーダのNTP時刻を正確に保つ

#### 受信機（ソース）
- **インテリジェント同期**: 2つのトリガーを使用したアダプティブ同期
  1. **キーフレームトリガー**: SEI付きキーフレーム（IDR）で同期（**最小10秒間隔**）
  2. **ドリフト検出**: 時刻ズレが設定した閾値を超えたとき（デフォルト50ms）
- **目的**: ネットワークオーバーヘッドを最小限にしながら高精度を維持
- **パフォーマンス**: 最小同期間隔が過度なNTPリクエストを防止

### NTP 設定推奨値

#### エンコーダ設定

| パラメータ | 範囲 | デフォルト | 推奨値 |
|-----------|-------|------------|----------|
| NTP 同期間隔 | 1-600秒 | 60秒 | **30-120秒** |

#### 受信機設定

| パラメータ | 範囲 | デフォルト | 推奨値 |
|-----------|-------|------------|----------|
| NTP ドリフト閾値 | 10-1000ms | 50ms | **30-100ms** |
| NTP 同期間隔 | 100ms-1h | 10s | **10-60秒** |

> **ℹ️ 注意**: 同期間隔は完全に設定可能になりました。パフォーマンス問題を防ぐため、設定値（デフォルト10秒）による最小間隔が適用されます。ネットワークとCPUが頻繁なNTPリクエストを処理できる場合は、この値を下げることができます。

### サポートされているエンコーダ

| エンコーダ名 | コーデック | サポートハードウェア | ステータス |
|-------------|------------|---------------------|------------|
| SEI Stamper (H.264) | H.264/AVC | Intel, NVIDIA, AMD | ✅ 確認済み |
| SEI Stamper (H.265) | H.265/HEVC | Intel, NVIDIA, AMD | ✅ 確認済み (推奨)|
| SEI Stamper (AV1) | AV1 | Intel, NVIDIA, AMD | ⚠️ (OBS SRT制限)|

---

## ソースからビルド

### 必要条件

- **CMake** 3.20以降
- **Visual Studio 2022**（C++デスクトップ開発ワークロード付き）
- **OBS Studioソースコード**（依存関係として含まれる）
- **FFmpegライブラリ**（OBSによって提供）
- **libsrt**（リポジトリに含まれる）

### クイックビルド（推奨）

ビルド経験のないユーザー向けに、自動ビルドスクリプトを使用：

1. **ビルドスクリプトを実行：**
   ```powershell
   # プロジェクトディレクトリに移動
   cd obs-sei-stamper
   
   # 自動ビルドスクリプトを実行
   .\build_and_install.bat
   ```

2. **プラグインを取得：**
   - ビルド成功後、プラグインファイルは`out/obs-studio/`ディレクトリに生成されます
   - プラグイン構造はOBSインストールディレクトリを反映

3. **インストール：**
   - `out/obs-studio/`の内容をOBSインストールディレクトリにコピー
   - デフォルト場所：`C:\Program Files\obs-studio`
   - **管理者権限が必要**

### 手動ビルド手順

ビルドプロセスを手動で制御したい場合：

1. **リポジトリをクローン：**
   ```bash
   git clone https://github.com/ikenainanodesu/sei-stamper.git
   cd obs-sei-stamper
   ```

2. **CMakeを設定：**
   ```powershell
   mkdir build
   cd build
   cmake .. -G "Visual Studio 17 2022" -A x64
   ```

3. **ビルド：**
   ```powershell
   cmake --build . --config Release
   ```

4. **インストール（オプション）：**
   ```powershell
   cmake --install . --config Release
   ```

5. **出力ファイル：**
   - プラグイン：`build/plugin/Release/sei-stamper.dll`
   - または簡単インストール用の`out/obs-studio/`ディレクトリ構造を使用

---

## トラブルシューティング

### 問題：エンコーダがOBSに表示されない

**解決策：**
- プラグインDLLが`obs-plugins/64bit/`ディレクトリにあることを確認
- OBSログで読み込みエラーを確認
- OBSバージョンが32.0.4以降であることを確認

### 問題：受信機がSRTに接続できない

**解決策：**
- `srt.dll`がインストールされていることを確認
- ファイアウォール設定を確認
- SRT URL形式を確認：`srt://ip:port`

### 問題：SEIデータが見つからない

**解決策：**
- NTPサーバーがアクセス可能であることを確認
- 「NTP同期を有効化」がチェックされていることを確認
- OBSログでNTP同期ステータスを確認

---

## パフォーマンス

- **CPUオーバーヘッド**: < 1%（SEI挿入）
- **NTP同期頻度**: 60秒ごと
- **フレーム精度**: 60fpsで±1フレーム
- **レイテンシ**: ~100ms（SRT 120msレイテンシ設定）

---

## コントリビューション

コントリビューションを歓迎します！プルリクエストをお気軽に送信してください。

### 開発ガイドライン

1. 既存のコードスタイルに従う
2. 複雑なロジックにはコメントを追加
3. 変更を徹底的にテスト
4. 必要に応じてドキュメントを更新

---

## 免責事項

このプロジェクトのコードとドキュメントの一部は、AIツールの支援を受けて生成されました。本ソフトウェアを使用することにより、以下の事項に同意したものとみなされます：
1. 本ソフトウェアは「現状のまま」提供され、いかなる種類の保証もありません。
2. 著者および貢献者は、本プラグインの使用に起因するいかなる損害やデータの損失についても責任を負いません。

---

## ライセンス

GPL-2.0 License - OBS Studioのライセンスに準拠

詳細は[LICENSE](LICENSE)ファイルを参照してください。

---

## クレジット

- **OBS Studio**: https://obsproject.com
- **libsrt**: https://github.com/Haivision/srt
- **FFmpeg**: https://ffmpeg.org
- **NTPプロトコル**: RFC 5905

---


## リリースノート

### v1.2.0 (2026-01-22)

**🎉 新機能:**
- ✨ **マルチコーデックサポート**: **H.265 (HEVC)** および **AV1** エンコード形式を完全サポート
  - **H.265**: H.264と比較して30-50%の帯域幅節約
  - **AV1**: 次世代の高効率圧縮
- 🛠️ **3つの独立したエンコーダ**:
  - `SEI STAMPER (H.264)`
  - `SEI STAMPER (H.265)`
  - `SEI STAMPER (AV1)`
  - 各エンコーダはハードウェアアクセラレーション（Intel/NVIDIA/AMD）をサポート
- 🧠 **スマート受信機**: ストリームのコーデック形式を自動検出します。手動による「Codec Format」選択を削除しました。

**⚠️ 重要な制限事項**:
- **H.264** および **H.265** は、SRTストリーミングで完全に動作確認されています。
- **AV1** エンコードは利用可能ですが、OBS Studioのバージョンによっては、SRT出力でのAV1ストリーミングがサポートされていない場合があります。

### v1.1.3 (2026-01-04)

**✨ 新機能:**
- ⚙️ **受信機同期間隔のカスタマイズ**: 受信機に `NTP Sync Interval` 設定を追加

### v1.1.2 (2026-01-04)

**🔧 バグ修正:**
- 🐛 **受信機のカクツキ修正**: NTP同期の重大なパフォーマンス修正
- 🛡️ **ネットワーク耐性**: インテリジェントなバックオフメカニズムを追加

### v1.1.0 (2026-01-04)

**🎉 新機能:**
- ✨ **NVIDIA NVENCサポート**
- ✨ **AMD AMFサポート**
- 🚀 **マルチGPUサポート**

### v1.0.0 (2026-01-04)

**初回リリース**

---

**現在のバージョン**: 1.2.0  
**最終更新**: 2026-01-22
